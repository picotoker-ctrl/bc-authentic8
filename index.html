<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Barcode Authenticator</title>

  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-YW1VWYLYBQ"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-YW1VWYLYBQ');
  </script>

  <!-- Include CryptoJS for decryption -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>

  <style>
    :root {
      --primary: #2c5aa0;
      --secondary: #1e3a5f;
      --success: #28a745;
      --danger: #dc3545;
      --warning: #ffc107;
      --light: #f8f9fa;
      --dark: #343a40;
      --gradient: linear-gradient(135deg, #2c5aa0 0%, #1e3a5f 100%);
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      margin: 0;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    
    .card {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      padding: 40px;
      border-radius: 20px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      width: 100%;
      max-width: 800px;
      text-align: center;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .logo-container {
      margin-bottom: 30px;
    }
    
    .logo {
      width: 80px;
      height: 80px;
      background: var(--gradient);
      border-radius: 50%;
      margin: 0 auto 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 32px;
      font-weight: bold;
      box-shadow: 0 8px 20px rgba(44, 90, 160, 0.3);
    }
    
    .barcode-icon {
      font-size: 36px;
    }
    
    h1 {
      margin: 0 0 10px;
      font-size: 32px;
      background: var(--gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      font-weight: 700;
    }
    
    .subtitle {
      color: var(--secondary);
      font-size: 16px;
      margin-bottom: 30px;
      opacity: 0.8;
    }
    
    .features {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin: 25px 0;
      flex-wrap: wrap;
    }
    
    .feature {
      display: flex;
      align-items: center;
      gap: 8px;
      background: var(--light);
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 14px;
      color: var(--dark);
    }
    
    .feature i {
      color: var(--primary);
    }
    
    .input-container {
      position: relative;
      margin: 30px 0;
    }
    
    input#code {
      width: 100%;
      padding: 18px 20px;
      font-size: 18px;
      border: 2px solid #e1e5eb;
      border-radius: 12px;
      outline: none;
      transition: all 0.3s ease;
      background: white;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
    }
    
    input#code:focus {
      border-color: var(--primary);
      box-shadow: 0 4px 20px rgba(44, 90, 160, 0.2);
      transform: translateY(-2px);
    }
    
    input#code::placeholder {
      color: #a0a0a0;
    }
    
    .button-group {
      display: flex;
      gap: 12px;
      justify-content: center;
      margin: 25px 0;
      flex-wrap: wrap;
    }
    
    .btn {
      padding: 15px 30px;
      font-size: 16px;
      border-radius: 12px;
      border: none;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
      min-width: 140px;
      justify-content: center;
    }
    
    .btn-primary {
      background: var(--gradient);
      color: white;
      box-shadow: 0 6px 20px rgba(44, 90, 160, 0.3);
    }
    
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(44, 90, 160, 0.4);
    }
    
    .btn-secondary {
      background: #6c757d;
      color: white;
    }
    
    .btn-secondary:hover {
      background: #5a6268;
      transform: translateY(-2px);
    }
    
    #result {
      margin-top: 25px;
      padding: 20px;
      border-radius: 12px;
      display: none;
      font-weight: 700;
      color: white;
      font-size: 18px;
      animation: fadeIn 0.5s ease;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .status {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 25px;
      padding: 15px;
      background: var(--light);
      border-radius: 10px;
      font-size: 14px;
    }
    
    .status-item {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .status-badge {
      background: var(--primary);
      color: white;
      padding: 4px 12px;
      border-radius: 20px;
      font-weight: 600;
      font-size: 12px;
    }
    
    #loading {
      display: none;
      color: var(--primary);
      margin: 20px 0;
      font-size: 16px;
    }
    
    .spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid var(--primary);
      border-radius: 50%;
      width: 20px;
      height: 20px;
      animation: spin 1s linear infinite;
      display: inline-block;
      margin-right: 10px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .security-notice {
      background: linear-gradient(135deg, #fff3cd, #ffeaa7);
      border: 1px solid #ffecb5;
      border-radius: 10px;
      padding: 15px;
      margin-top: 25px;
      font-size: 13px;
      color: #856404;
    }
    
    .prefix-badges {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin: 15px 0;
      flex-wrap: wrap;
    }
    
    .prefix-badge {
      background: var(--secondary);
      color: white;
      padding: 6px 12px;
      border-radius: 15px;
      font-size: 12px;
      font-weight: 600;
    }
    
    /* Responsive design */
    @media (max-width: 768px) {
      .card {
        padding: 30px 20px;
        margin: 10px;
      }
      
      h1 {
        font-size: 28px;
      }
      
      .button-group {
        flex-direction: column;
        align-items: center;
      }
      
      .btn {
        width: 100%;
        max-width: 300px;
      }
      
      .features {
        flex-direction: column;
        align-items: center;
      }
    }
  </style>
</head>
<body>
  <div class="card">
    <!-- Logo Section -->
    <div class="logo-container">
      <div class="logo">
        <span class="barcode-icon">⎸</span>
      </div>
      <h1>Barcode Authenticator</h1>
      <p class="subtitle">Advanced Security Verification System</p>
    </div>

    <!-- Features -->
    <div class="features">
      <div class="feature">
        <i>✓</i> Military-Grade Encryption
      </div>
      <div class="feature">
        <i>✓</i> Real-time Validation
      </div>
      <div class="feature">
        <i>✓</i> Multi-Prefix Support
      </div>
    </div>

    <!-- Supported Prefixes -->
    <div class="prefix-badges">
      <div class="prefix-badge">7561097010000001</div>
      <div class="prefix-badge">7561097010000002</div>
    </div>

    <!-- Loading Indicator -->
    <div id="loading">
      <div class="spinner"></div>
      Decrypting secure database...
    </div>

    <!-- Main Input -->
    <div class="input-container">
      <input 
        id="code" 
        type="text" 
        inputmode="text" 
        autocomplete="off" 
        autocorrect="off" 
        autocapitalize="off" 
        spellcheck="false" 
        placeholder="Scan barcode - auto-verifies on scan" 
      />
    </div>

    <!-- Action Buttons -->
    <div class="button-group">
      <button id="check" class="btn btn-primary">
        <i>✓</i> Verify Now
      </button>
      <button id="clear" class="btn btn-secondary">
        <i>↻</i> Clear
      </button>
    </div>

    <!-- Result Display -->
    <div id="result" role="status" aria-live="polite"></div>

    <!-- Status Bar -->
    <div class="status">
      <div class="status-item">
        <span>Database Status:</span>
        <span class="status-badge" id="count">0</span>
      </div>
      <div class="status-item">
        <span>Security Level:</span>
        <span class="status-badge">AES-256</span>
      </div>
    </div>

    <!-- Security Notice -->
    <div class="security-notice">
      <strong>Secure Verification:</strong> All barcode data is encrypted using military-grade AES-256 encryption. 
      No sensitive information is stored in plain text.
    </div>
  </div>

  <script>
    // script.js - Secure version with AES encryption - MULTIPLE PREFIXES + AUTO-AUTHENTICATE
    const VALID_PREFIXES = ["7561097010000001", "7561097010000002"];
    const CODE_LEN = 28;
    const encryptedDataUrl = 'encrypted-barcodes.json';
    const ENCRYPTION_KEY = "my-super-secret-key-32-chars-long!"; // CHANGE THIS!

    const codeInput = document.getElementById('code');
    const checkBtn = document.getElementById('check');
    const clearBtn = document.getElementById('clear');
    const resultDiv = document.getElementById('result');
    const countSpan = document.getElementById('count');
    const loadingDiv = document.getElementById('loading');

    let decryptedCodesSet = new Set();
    let isDatabaseLoaded = false;
    let autoCheckTimeout = null;

    // Show/hide loading
    function showLoading(show) {
        loadingDiv.style.display = show ? 'block' : 'none';
    }

    // Show result
    function showResult(isGenuine, message) {
      resultDiv.style.display = 'block';
      resultDiv.style.background = isGenuine ? 'var(--success)' : 'var(--danger)';
      resultDiv.textContent = message;
    }

    // Decrypt a single barcode
    function decryptBarcode(encryptedBarcode) {
        try {
            const decrypted = CryptoJS.AES.decrypt(encryptedBarcode, ENCRYPTION_KEY);
            return decrypted.toString(CryptoJS.enc.Utf8);
        } catch (error) {
            console.error('Decryption error:', error);
            return null;
        }
    }

    // Load and decrypt encrypted barcodes
    async function loadEncryptedCodes() {
        showLoading(true);
        
        try {
            const response = await fetch(encryptedDataUrl, {cache: "no-store"});
            if (!response.ok) throw new Error('Failed to load encrypted database');
            
            const encryptedData = await response.json();
            
            if (!encryptedData.encrypted) {
                throw new Error('Data file is not encrypted format');
            }
            
            // Decrypt each barcode
            let validCount = 0;
            let prefix1Count = 0;
            let prefix2Count = 0;
            
            for (const encryptedBarcode of encryptedData.data) {
                const decrypted = decryptBarcode(encryptedBarcode);
                if (decrypted && decrypted.length === CODE_LEN) {
                    decryptedCodesSet.add(decrypted);
                    validCount++;
                    
                    // Count by prefix for debugging
                    if (decrypted.startsWith("7561097010000001")) {
                        prefix1Count++;
                    } else if (decrypted.startsWith("7561097010000002")) {
                        prefix2Count++;
                    }
                }
            }
            
            countSpan.textContent = validCount;
            isDatabaseLoaded = true;
            console.log(`Decrypted and loaded ${validCount} barcodes (Prefix1: ${prefix1Count}, Prefix2: ${prefix2Count})`);
            
        } catch (error) {
            console.error('Database loading error:', error);
            showResult(false, 'Error: Could not load encrypted database');
            countSpan.textContent = '0';
        } finally {
            showLoading(false);
        }
    }

    // Validate format with multiple prefixes
    function basicFormatOkay(code) {
      if (!code || code.length !== CODE_LEN) return false;
      
      // Check if code starts with any valid prefix
      const hasValidPrefix = VALID_PREFIXES.some(prefix => code.startsWith(prefix));
      if (!hasValidPrefix) return false;
      
      // Validate the remaining characters
      const remainingChars = code.slice(16);
      return /^[0-9a-z]+$/.test(remainingChars);
    }

    // Get prefix type for analytics
    function getPrefixType(code) {
        if (code.startsWith("7561097010000001")) return "Type-1";
        if (code.startsWith("7561097010000002")) return "Type-2";
        return "Unknown";
    }

    // Auto-check function with debouncing
    function autoCheck() {
        if (!isDatabaseLoaded) return;
        
        const raw = codeInput.value.trim();
        const code = raw.toLowerCase();
        
        // Clear previous timeout
        if (autoCheckTimeout) {
            clearTimeout(autoCheckTimeout);
        }
        
        // Set new timeout for auto-check (300ms after user stops typing)
        autoCheckTimeout = setTimeout(() => {
            if (code && code.length === CODE_LEN) {
                performCheck();
            }
        }, 300);
    }

    // Perform check
    function performCheck() {
      if (!isDatabaseLoaded) {
        showResult(false, 'Database not ready. Please wait.');
        return;
      }

      const raw = codeInput.value.trim();
      const code = raw.toLowerCase();

      if (!code) {
        resultDiv.style.display = 'none';
        return;
      }
      
      if (!basicFormatOkay(code)) {
        showResult(false, 'COUNTERFEIT ✗ — invalid format or prefix');
        logAnalytics(code, 'format-invalid');
        return;
      }

      const isGenuine = decryptedCodesSet.has(code);
      if (isGenuine) {
        const prefixType = getPrefixType(code);
        showResult(true, `GENUINE ✓ (${prefixType})`);
        logAnalytics(code, 'genuine', prefixType);
      } else {
        showResult(false, 'COUNTERFEIT ✗');
        logAnalytics(code, 'counterfeit');
      }
    }

    // Enhanced analytics logging with prefix type
    function logAnalytics(code, result, prefixType = null) {
      if (typeof gtag === 'function') {
        try {
          gtag('event', 'barcode_check', {
            'barcode_prefix': code.substring(0, 16),
            'barcode_type': prefixType || getPrefixType(code),
            'result': result,
            'page_location': window.location.href,
            'auto_authenticated': 'true'
          });
        } catch (e) { /* ignore analytics errors */ }
      }
    }

    // Clear function
    function clearInput() {
        codeInput.value = '';
        resultDiv.style.display = 'none';
        codeInput.focus();
        
        // Clear any pending auto-check
        if (autoCheckTimeout) {
            clearTimeout(autoCheckTimeout);
        }
    }

    // Event listeners
    checkBtn.addEventListener('click', performCheck);
    clearBtn.addEventListener('click', clearInput);

    // Auto-authentication events
    codeInput.addEventListener('input', autoCheck);
    codeInput.addEventListener('paste', autoCheck);

    // Scanner detection - many scanners send Enter key after scanning
    codeInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            // If we already auto-checked, don't check again
            // If not, perform the check
            if (resultDiv.style.display === 'none') {
                performCheck();
            }
            e.preventDefault();
        }
    });

    // Focus the input field when page loads
    window.addEventListener('load', () => {
        codeInput.focus();
    });

    // Initialize
    loadEncryptedCodes();
  </script>
</body>
</html>
